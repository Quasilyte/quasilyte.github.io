<!-- head -->

<title>C APIs and closures</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<script src="app.js"></script>

<!-- body -->

<div id="header" class="header"></div>
<div id="post-info"></div>

<div class="box">
  <h3 class="chapter"><a name="fn">Function pointers</a></h3>

  <p>
    Even if you program in C for food, you still can be annoyed
    by function pointer syntax when it comes to something like
    high-order functions or functions that returns another
    function pointer. 
  </p>

  <p>
    Consider we defined these simple functions:
  </p>

  <pre id="simple-functions" title="Simple functions" class="snippet"></pre>

  <p>
    Now we need to define a function that returns on of these functions.
    We will call it "get_op".
    Another function that we need should return previous function,
    that is, function that returns a function pointer to a function that
    returns a function pointer; call it a "get_gettet".
  </p>

  <pre id="fn-bad" title="Hard to read" class="snippet"></pre>

  <p>
    Not really pleasant to write nor read.
    There is an workaround which needs compiler that supports "typeof" feature.
  </p>

  <pre id="fn-macro" title="Macro for function types" class="snippet"></pre>

  <p>
    With that, we can rewrite previous code snippet.
  </p>

  <pre id="fn-good" title="Nice to read" class="snippet"></pre>

  <p>
    The best part about it is that we can now
    separate function type with its name (be it a function name
    or a variable name that holds a function pointer).
  </p>
</div>

<script id="simple-functions-src" type="text/tempate">
int identity(int x) { return x; }
int add1(int x) { return x + 1; }
int sub1(int x) { return x - 1; }
</script>

<script id="fn-bad-src" type="text/tempate">
int(*get_op(char type))(int) {
  return type == '+' ? add1 :
         type == '-' ? sub1 :
         identity;
}

int(*(*get_getter(void))(char))(int) {
  return get_op;
}

int main() {
  int(*(*get_op)(char))(int) = get_getter();
  int(*add1)(int) = get_op('+');
  int(*sub1)(int) = get_op('-');
  printf("%d %d\n", add1(2), sub1(2));
}
</script>

<script id="fn-macro-src" type="text/tempate">
#define fn(params, ret_type) typeof(ret_type(*)params)
</script>

<script id="fn-good-src" type="text/tempate">
fn((int), int) get_op(char type) {
  return type == '+' ? add1 :
         type == '-' ? sub1 :
         identity;
}

fn((char), fn((int), int)) get_getter() {
  return get_op;
}

int main() {
  fn((char), fn((int), int)) get_op = get_getter();
  fn((int), int) add1 = get_op('+');
  fn((int), int) sub1 = get_op('-');
  printf("%d %d\n", add1(2), sub1(2));
}
</script>

<div id="footer"></div>

<script>
  App.enrichContent({
  });
</script> 
